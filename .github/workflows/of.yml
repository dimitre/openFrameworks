name: OF
# make the action not run on the local repo if the branch is also in a pull request to OF/OF
on:
  push:
    if: github.event_name == 'push' && github.event.pull_request == null
    paths-ignore:
      - "**/*.md"
      - "examples/**"
  pull_request:
    if: github.event_name == 'pull_request' && github.repository == 'openframeworks/openFrameworks'
    paths-ignore:
      - "**/*.md"
      - "examples/**"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  ccache: ccache
  RELEASE: latest

jobs:
  build-macos:
    runs-on: macos-15
    strategy:
      matrix:
        cfg:
          - { target: osx, opt: "xcode" }
          - { target: osx, opt: "makefiles" }
    steps:
      - uses: actions/checkout@v4
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.14
        with:
          key: ${{ matrix.cfg.target }}-${{ matrix.cfg.opt }}

      # - name: Determine Release
      #   id: vars
      #   shell: bash
      #   run: |
      #     if [[ "${{ github.ref }}" == refs/tags/* ]]; then
      #       echo "RELEASE=${{ github.ref_name }}" >> $GITHUB_ENV
      #     elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
      #       echo "RELEASE=nightly" >> $GITHUB_ENV
      #     elif [[ "${{ github.ref }}" == "refs/heads/bleeding" ]]; then
      #       echo "RELEASE=latest" >> $GITHUB_ENV
      #     else
      #       echo "RELEASE=latest" >> $GITHUB_ENV
      #     fi

      - name: Download libs
        run: ./scripts/${{ matrix.cfg.target }}/download_libs.sh -t $RELEASE

      - name: Build
        run: if [ ${{ matrix.cfg.opt }} = "xcode" ]; then
          scripts/ci/${{ matrix.cfg.target }}/build.sh ${{ matrix.cfg.opt }};
          else
          scripts/ci/${{ matrix.cfg.target }}/run_tests.sh;
          fi
        env:
          DEVELOPER_DIR: "/Applications/Xcode.app/Contents/Developer"
          SDKROOT: "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
